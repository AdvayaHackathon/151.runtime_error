{% extends "base.html" %}

{% block title %}Comprehensive Results{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <h2 class="h5 mb-0">Your Comprehensive Mental Health Assessment</h2>
            </div>
            
            <div class="card-body p-4">
                <h3 class="h4 mb-3 text-center">Assessment Overview</h3>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                Phase 1: PHQ-8
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">Depression Screening</h5>
                                <p class="card-text">Score: <span class="badge bg-primary">{{ phq8_score }}</span></p>
                                {% if phq8_score <= 4 %}
                                    <p class="card-text">Severity: <strong>None/minimal</strong></p>
                                {% elif phq8_score <= 9 %}
                                    <p class="card-text">Severity: <strong>Mild</strong></p>
                                {% elif phq8_score <= 14 %}
                                    <p class="card-text">Severity: <strong>Moderate</strong></p>
                                {% elif phq8_score <= 19 %}
                                    <p class="card-text">Severity: <strong>Moderately severe</strong></p>
                                {% else %}
                                    <p class="card-text">Severity: <strong>Severe</strong></p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                Phase 2: Game
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">Cognitive Assessment</h5>
                                <p class="card-text">Score: <span class="badge bg-success">{{ game_data.score }}</span></p>
                                {% if game_data.features %}
                                    <p class="card-text">Reaction time: <strong>{{ "%.0f"|format(game_data.features.avg_reaction_time) }}ms</strong></p>
                                    <p class="card-text">Accuracy: <strong>{{ "%.1f"|format(game_data.features.accuracy) }}%</strong></p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                Phase 3: Video
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">Emotional Analysis</h5>
                                <p class="card-text">Dominant: <span class="badge bg-info">{{ dominant_emotion_label }}</span></p>
                                
                                {% if emotion_counts %}
                                <div class="small mt-2">
                                    <div>Distribution:</div>
                                    {% for emotion, count in emotion_counts.items() %}
                                        {% if count > 0 %}
                                            <div>{{ emotion }}: {{ count }}</div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <div class="mt-3">
                                    <h6>Blink Analysis</h6>
                                    <p>Total Blinks: <strong>{{ blink_count }}</strong></p>
                                    <p>Blink Rate: <strong>{{ "%.1f"|format(blink_rate) }}</strong> blinks/min</p>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Gaze Analysis</h6>
                                    <p>Looking Left: <strong>{{ looking_left_count }}</strong> frames</p>
                                    <p>Looking Right: <strong>{{ looking_right_count }}</strong> frames</p>
                                    <p>Looking Center: <strong>{{ looking_center_count }}</strong> frames</p>
                                    <p>Right/Left Ratio: <strong>{{ "%.2f"|format(ratio_gaze_on_roi) }}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="h5 mb-3">Emotional Indicators</h4>
                    <div class="card">
                        <div class="card-body">
                            {% if game_data.emotional_indicators %}
                                <ul>
                                {% for indicator in game_data.emotional_indicators %}
                                    <li>
                                        <strong>{{ indicator.emotion }}</strong> ({{ "%.0f"|format(indicator.confidence * 100) }}% confidence)
                                        <ul>
                                            {% for detail in indicator.indicators %}
                                                <li>{{ detail }}</li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <p>No significant emotional indicators detected in gameplay.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="h5 mb-3">Integrated Analysis</h4>
                    <div class="card">
                        <div class="card-body">
                            <p>Based on the combined analysis of all three assessment phases:</p>
                            <ul>
                                {% if phq8_score > 9 %}
                                    <li><strong>Mood:</strong> Significant depressive symptoms detected through self-report (PHQ-8)</li>
                                {% elif phq8_score > 4 %}
                                    <li><strong>Mood:</strong> Mild depressive symptoms detected</li>
                                {% else %}
                                    <li><strong>Mood:</strong> Minimal or no depressive symptoms reported</li>
                                {% endif %}
                                
                                {% if game_data.features and game_data.features.avg_reaction_time %}
                                    {% if game_data.features.avg_reaction_time < 800 %}
                                        <li><strong>Cognition:</strong> Quick reaction times ({{ "%.0f"|format(game_data.features.avg_reaction_time) }}ms)</li>
                                    {% elif game_data.features.avg_reaction_time < 1200 %}
                                        <li><strong>Cognition:</strong> Normal reaction times ({{ "%.0f"|format(game_data.features.avg_reaction_time) }}ms)</li>
                                    {% else %}
                                        <li><strong>Cognition:</strong> Slower reaction times ({{ "%.0f"|format(game_data.features.avg_reaction_time) }}ms)</li>
                                    {% endif %}
                                {% endif %}
                                
                                <li><strong>Emotional Expression:</strong> Predominantly {{ dominant_emotion_label }} expressions during video analysis</li>
                                <li><strong>Blink Analysis:</strong> {{ blink_count }} blinks detected ({{ "%.1f"|format(blink_rate) }} blinks/min)</li>
                                
                                {% if total_gaze_frames > 0 %}
                                    {% if looking_left_count > looking_right_count %}
                                        <li><strong>Gaze Patterns:</strong> Tendency to look left ({{ "%.1f"|format(looking_left_count / total_gaze_frames * 100) }}% of frames)</li>
                                    {% elif looking_right_count > looking_left_count %}
                                        <li><strong>Gaze Patterns:</strong> Tendency to look right ({{ "%.1f"|format(looking_right_count / total_gaze_frames * 100) }}% of frames)</li>
                                    {% else %}
                                        <li><strong>Gaze Patterns:</strong> Balanced eye movement with no directional bias</li>
                                    {% endif %}
                                    
                                    <li><strong>Gaze Ratio (Right:Left):</strong> {{ "%.2f"|format(ratio_gaze_on_roi) }} (values >1 indicate right preference, <1 left preference)</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mb-4">
                    <h4 class="h6">Important Disclaimer</h4>
                    <p class="mb-0">This assessment is not a diagnostic tool and should not replace professional evaluation. The results are intended to provide insights into patterns that may warrant further attention.</p>
                </div>
                
                <div class="d-grid gap-2 col-md-6 mx-auto">
                    <a href="{{ url_for('main.index') }}" class="btn btn-primary">Start New Assessment</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 